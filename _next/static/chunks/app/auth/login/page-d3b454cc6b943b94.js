(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4859],{3486:(e,r,t)=>{Promise.resolve().then(t.bind(t,9598))},5695:(e,r,t)=>{"use strict";var s=t(8999);t.o(s,"useParams")&&t.d(r,{useParams:function(){return s.useParams}}),t.o(s,"usePathname")&&t.d(r,{usePathname:function(){return s.usePathname}}),t.o(s,"useRouter")&&t.d(r,{useRouter:function(){return s.useRouter}}),t.o(s,"useSearchParams")&&t.d(r,{useSearchParams:function(){return s.useSearchParams}})},9323:(e,r,t)=>{"use strict";async function s(e){let r=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",r))).map(e=>e.toString(16).padStart(2,"0")).join("")}t.d(r,{M3:()=>x,Wy:()=>w,aN:()=>f,iD:()=>g,ku:()=>u,kz:()=>h,lo:()=>d,ri:()=>p,saveUsers:()=>c,u6:()=>m});let o="users",a="users_backup",n=!1,i=!1;function l(e){if(!e)return null;try{let r=JSON.parse(e);return Array.isArray(r)?r:null}catch(e){return console.error("❌ Error parsing users JSON:",e),null}}function d(){let e=l(localStorage.getItem(o));if(e)return e;let r=l(localStorage.getItem(a));return r?(console.warn("⚠️ Using users_backup because users JSON is invalid"),r):(console.log("\uD83D\uDCCB No valid users found in localStorage"),[])}function c(e){try{if(!Array.isArray(e)){console.error("❌ Cannot save users: not an array",e);return}let r=localStorage.getItem(o);r&&localStorage.setItem(a,r),localStorage.setItem(o,JSON.stringify(e)),localStorage.setItem("users_last_updated",Date.now().toString()),console.log("✅ Saved users to localStorage:",e.length,"users"),"undefined"!=typeof fetch&&Promise.all([fetch("http://localhost:3000/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null),fetch("http://localhost:3001/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null)]).then(()=>{console.log("\uD83D\uDCE1 Synced users to both ports via API")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)}),window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event from saveUsers")}catch(e){console.error("❌ Error saving users:",e)}}function u(){if(n)return;n=!0;try{if("1"===window.sessionStorage.getItem("admin_users_migrated_once"))return}catch(e){}let e=localStorage.getItem(o),r=localStorage.getItem("admin_users"),t=l(e)||[];if(r)try{let e=l(r)||[];if(Array.isArray(e)&&e.length>0){let r=e.map(e=>{let r=new Date().toISOString();if(e.joinDate)try{let t=new Date(e.joinDate);isNaN(t.getTime())||(r=t.toISOString())}catch(e){r=new Date().toISOString()}return{id:e.id||Date.now()+Math.random(),name:e.name||"",email:e.email||"",phone:e.phone||"",role:"admin"===e.role?"admin":"user",passwordHash:e.passwordHash||"",createdAt:r,orders:e.orders||0,totalSpent:e.totalSpent||"۰",status:e.status||"active",joinDate:e.joinDate,visibleGiftCards:e.visibleGiftCards||[]}}),s=new Map,o=e=>{let r=e.email&&e.email.trim().toLowerCase()||e.phone&&e.phone.trim()||e.id.toString();s.has(r)||s.set(r,e)};t.forEach(o),r.forEach(o);let a=Array.from(s.values());a.length!==t.length&&(console.log("✅ Migrated and merged users from admin_users into users:","before:",t.length,"after:",a.length),c(a)),localStorage.removeItem("admin_users"),localStorage.setItem("admin_users_migrated","true");try{window.sessionStorage.setItem("admin_users_migrated_once","1")}catch(e){}}}catch(e){console.error("❌ Error migrating users:",e)}}async function m(){if(!i){i=!0;try{if("1"===window.sessionStorage.getItem("admin_seeded_once"))return}catch(e){}try{let e=d();if(0===e.length)console.log("ℹ️ No users found, seeding default admin user");else if(e.some(e=>"admin"===e.role||"admin@example.com"===e.email))return;let r=await s("Admin@12345"),t={id:Date.now(),name:"مدیر سیستم",email:"admin@example.com",phone:"",role:"admin",passwordHash:r,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};e.push(t),c(e),console.log("✅ Seeded default admin user:",t.email);try{window.sessionStorage.setItem("admin_seeded_once","1")}catch(e){}}catch(e){console.error("❌ Error seeding admin user:",e)}}}async function h(e,r,t,o){try{let a=d(),n=r.trim(),i=t.trim();console.log("\uD83D\uDD0D Registering user:",{name:e,email:n,phone:i,totalUsers:a.length});let l=a.find(e=>n&&e.email&&e.email===n?(console.log("❌ Found existing user with email:",e.email),!0):!!i&&!!e.phone&&e.phone===i&&(console.log("❌ Found existing user with phone:",e.phone),!0));if(l)return console.log("❌ User already exists:",l),{success:!1,error:"این ایمیل یا شماره تلفن قبلاً ثبت شده است"};console.log("✅ No duplicate found, creating new user...");let u=await s(o),m={id:Date.now(),name:e.trim(),email:n,phone:i,role:"user",passwordHash:u,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};a.push(m),c(a),console.log("✅ New user registered and saved:",{id:m.id,name:m.name,email:m.email,phone:m.phone,totalUsers:a.length});try{fetch("/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:a})}).then(()=>{console.log("\uD83D\uDCE1 Synced users to API endpoint")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)})}catch(e){}return window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event"),{success:!0,user:m}}catch(e){return console.error("Registration error:",e),{success:!1,error:"خطا در ثبت نام"}}}async function g(e,r){try{let t=d(),o=e.includes("@"),a=o?e.trim():"",n=o?"":e.trim(),i=t.find(e=>e.email===a||e.phone===n);if(!i)return{success:!1,error:"Invalid email/phone or password"};if(!i.passwordHash||""===i.passwordHash)return{success:!1,error:"این حساب کاربری نیاز به تنظیم مجدد رمز عبور دارد. لطفاً دوباره ثبت نام کنید."};let l=await s(r);if(i.passwordHash!==l)return{success:!1,error:"Invalid email/phone or password"};return localStorage.setItem("session_user_id",i.id.toString()),localStorage.setItem("user_email",i.email),localStorage.setItem("user_phone",i.phone),localStorage.setItem("user_name",i.name),{success:!0,user:i}}catch(e){return console.error("Login error:",e),{success:!1,error:"خطا در ورود"}}}function p(){localStorage.removeItem("session_user_id"),localStorage.removeItem("user_email"),localStorage.removeItem("user_phone"),localStorage.removeItem("user_name")}function f(){try{let e=localStorage.getItem("session_user_id");if(!e)return null;return d().find(r=>r.id.toString()===e)||null}catch(e){return console.error("Error getting session user:",e),null}}function x(){return null!==f()}function w(){p()}},9598:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>c});var s=t(5155),o=t(2115),a=t(5695),n=t(6874),i=t.n(n),l=t(9323);function d(){let e=(0,a.useRouter)(),r=(0,a.useSearchParams)(),[t,n]=(0,o.useState)(!1),[d,c]=(0,o.useState)(""),[u,m]=(0,o.useState)("");(0,o.useEffect)(()=>(document.body.style.overflow="hidden",()=>{document.body.style.overflow=""}),[]),(0,o.useEffect)(()=>{"true"===r.get("registered")&&m("ثبت نام با موفقیت انجام شد. لطفاً وارد شوید.")},[r]);let h=async t=>{t.preventDefault(),n(!0),c(""),m("");let s=new FormData(t.currentTarget),o=s.get("identifier"),a=s.get("password");if(!o||!a){c("لطفاً تمام فیلدها را پر کنید"),n(!1);return}try{var i;let t=await (0,l.iD)(o.trim(),a);if(!t.success){c(t.error||"ایمیل/شماره تلفن یا رمز عبور اشتباه است"),n(!1);return}let s=r.get("redirect");(null===(i=t.user)||void 0===i?void 0:i.role)==="admin"?e.push("/admin"):s?e.push(s):e.push("/dashboard")}catch(e){console.error("Login error:",e),c("خطا در ورود. لطفاً دوباره تلاش کنید."),n(!1)}};return(0,s.jsxs)("div",{className:"fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 z-50 overflow-y-auto flex items-center justify-center p-4",children:[(0,s.jsx)("div",{className:"absolute inset-0 opacity-[0.03] pointer-events-none",children:(0,s.jsx)("div",{className:"absolute inset-0",style:{backgroundImage:"radial-gradient(circle at 2px 2px, white 1px, transparent 0)",backgroundSize:"40px 40px"}})}),(0,s.jsx)("div",{className:"relative z-10 w-full max-w-md",children:(0,s.jsxs)("div",{className:"glass-card rounded-2xl p-8 shadow-2xl border border-white/10",children:[(0,s.jsxs)("div",{className:"mb-8 text-center",children:[(0,s.jsx)("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 mb-4",children:(0,s.jsx)("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),(0,s.jsx)("h1",{className:"text-3xl font-bold text-white mb-2",children:"ورود به حساب کاربری"}),(0,s.jsx)("p",{className:"text-sm text-gray-400",children:"به حساب کاربری خود وارد شوید"})]}),u&&(0,s.jsxs)("div",{className:"mb-4 p-4 bg-green-500/20 border border-green-500/30 rounded-lg text-sm text-green-300 flex items-center gap-2",children:[(0,s.jsx)("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),u]}),d&&(0,s.jsxs)("div",{className:"mb-4 p-4 bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-300 flex items-center gap-2",children:[(0,s.jsx)("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),d]}),(0,s.jsxs)("form",{onSubmit:h,className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"identifier",className:"block text-sm font-medium text-gray-300 mb-2",children:"ایمیل یا شماره تلفن"}),(0,s.jsx)("input",{id:"identifier",name:"identifier",type:"text",required:!0,disabled:t,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed",placeholder:"example@email.com یا 09123456789"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-300 mb-2",children:"رمز عبور"}),(0,s.jsx)("input",{id:"password",name:"password",type:"password",required:!0,disabled:t,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed",placeholder:"••••••••"})]}),(0,s.jsx)("button",{type:"submit",disabled:t,className:"w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg hover:shadow-blue-500/25 transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:t?"در حال ورود...":"ورود"})]}),(0,s.jsxs)("div",{className:"mt-6 text-center space-y-2",children:[(0,s.jsxs)("p",{className:"text-sm text-gray-400",children:["حساب کاربری ندارید؟"," ",(0,s.jsx)(i(),{href:"/auth/register",className:"text-blue-400 hover:text-blue-300 font-medium",children:"ثبت نام کنید"})]}),(0,s.jsx)("p",{className:"text-sm text-gray-400",children:(0,s.jsx)(i(),{href:"/admin/login",className:"text-purple-400 hover:text-purple-300 font-medium",children:"ورود به پنل ادمین"})})]})]})})]})}function c(){return(0,s.jsx)(o.Suspense,{fallback:(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 relative flex items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-400",children:"در حال بارگذاری..."})]})}),children:(0,s.jsx)(d,{})})}}},e=>{var r=r=>e(e.s=r);e.O(0,[6874,8441,1684,7358],()=>r(3486)),_N_E=e.O()}]);