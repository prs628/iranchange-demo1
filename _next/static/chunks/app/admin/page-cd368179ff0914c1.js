(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3698],{5695:(e,t,r)=>{"use strict";var s=r(8999);r.o(s,"useParams")&&r.d(t,{useParams:function(){return s.useParams}}),r.o(s,"usePathname")&&r.d(t,{usePathname:function(){return s.usePathname}}),r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}}),r.o(s,"useSearchParams")&&r.d(t,{useSearchParams:function(){return s.useSearchParams}})},6161:(e,t,r)=>{Promise.resolve().then(r.bind(r,7161))},7161:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>i});var s=r(5155),o=r(2115),n=r(5695),a=r(9323);function i(){let e=(0,n.useRouter)(),[t,r]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{let t=(0,a.aN)();(0,a.M3)()&&(null==t?void 0:t.role)==="admin"?e.push("/admin/dashboard"):e.push("/admin/login"),r(!1)},[e]),(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-slate-400",children:"در حال هدایت..."})]})})}},9323:(e,t,r)=>{"use strict";async function s(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}r.d(t,{M3:()=>S,Wy:()=>y,aN:()=>f,iD:()=>h,ku:()=>d,kz:()=>g,lo:()=>c,ri:()=>p,saveUsers:()=>u,u6:()=>m});let o="users",n="users_backup",a=!1,i=!1;function l(e){if(!e)return null;try{let t=JSON.parse(e);return Array.isArray(t)?t:null}catch(e){return console.error("❌ Error parsing users JSON:",e),null}}function c(){let e=l(localStorage.getItem(o));if(e)return e;let t=l(localStorage.getItem(n));return t?(console.warn("⚠️ Using users_backup because users JSON is invalid"),t):(console.log("\uD83D\uDCCB No valid users found in localStorage"),[])}function u(e){try{if(!Array.isArray(e)){console.error("❌ Cannot save users: not an array",e);return}let t=localStorage.getItem(o);t&&localStorage.setItem(n,t),localStorage.setItem(o,JSON.stringify(e)),localStorage.setItem("users_last_updated",Date.now().toString()),console.log("✅ Saved users to localStorage:",e.length,"users"),"undefined"!=typeof fetch&&Promise.all([fetch("http://localhost:3000/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null),fetch("http://localhost:3001/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null)]).then(()=>{console.log("\uD83D\uDCE1 Synced users to both ports via API")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)}),window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event from saveUsers")}catch(e){console.error("❌ Error saving users:",e)}}function d(){if(a)return;a=!0;try{if("1"===window.sessionStorage.getItem("admin_users_migrated_once"))return}catch(e){}let e=localStorage.getItem(o),t=localStorage.getItem("admin_users"),r=l(e)||[];if(t)try{let e=l(t)||[];if(Array.isArray(e)&&e.length>0){let t=e.map(e=>{let t=new Date().toISOString();if(e.joinDate)try{let r=new Date(e.joinDate);isNaN(r.getTime())||(t=r.toISOString())}catch(e){t=new Date().toISOString()}return{id:e.id||Date.now()+Math.random(),name:e.name||"",email:e.email||"",phone:e.phone||"",role:"admin"===e.role?"admin":"user",passwordHash:e.passwordHash||"",createdAt:t,orders:e.orders||0,totalSpent:e.totalSpent||"۰",status:e.status||"active",joinDate:e.joinDate,visibleGiftCards:e.visibleGiftCards||[]}}),s=new Map,o=e=>{let t=e.email&&e.email.trim().toLowerCase()||e.phone&&e.phone.trim()||e.id.toString();s.has(t)||s.set(t,e)};r.forEach(o),t.forEach(o);let n=Array.from(s.values());n.length!==r.length&&(console.log("✅ Migrated and merged users from admin_users into users:","before:",r.length,"after:",n.length),u(n)),localStorage.removeItem("admin_users"),localStorage.setItem("admin_users_migrated","true");try{window.sessionStorage.setItem("admin_users_migrated_once","1")}catch(e){}}}catch(e){console.error("❌ Error migrating users:",e)}}async function m(){if(!i){i=!0;try{if("1"===window.sessionStorage.getItem("admin_seeded_once"))return}catch(e){}try{let e=c();if(0===e.length)console.log("ℹ️ No users found, seeding default admin user");else if(e.some(e=>"admin"===e.role||"admin@example.com"===e.email))return;let t=await s("Admin@12345"),r={id:Date.now(),name:"مدیر سیستم",email:"admin@example.com",phone:"",role:"admin",passwordHash:t,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};e.push(r),u(e),console.log("✅ Seeded default admin user:",r.email);try{window.sessionStorage.setItem("admin_seeded_once","1")}catch(e){}}catch(e){console.error("❌ Error seeding admin user:",e)}}}async function g(e,t,r,o){try{let n=c(),a=t.trim(),i=r.trim();console.log("\uD83D\uDD0D Registering user:",{name:e,email:a,phone:i,totalUsers:n.length});let l=n.find(e=>a&&e.email&&e.email===a?(console.log("❌ Found existing user with email:",e.email),!0):!!i&&!!e.phone&&e.phone===i&&(console.log("❌ Found existing user with phone:",e.phone),!0));if(l)return console.log("❌ User already exists:",l),{success:!1,error:"این ایمیل یا شماره تلفن قبلاً ثبت شده است"};console.log("✅ No duplicate found, creating new user...");let d=await s(o),m={id:Date.now(),name:e.trim(),email:a,phone:i,role:"user",passwordHash:d,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};n.push(m),u(n),console.log("✅ New user registered and saved:",{id:m.id,name:m.name,email:m.email,phone:m.phone,totalUsers:n.length});try{fetch("/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:n})}).then(()=>{console.log("\uD83D\uDCE1 Synced users to API endpoint")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)})}catch(e){}return window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event"),{success:!0,user:m}}catch(e){return console.error("Registration error:",e),{success:!1,error:"خطا در ثبت نام"}}}async function h(e,t){try{let r=c(),o=e.includes("@"),n=o?e.trim():"",a=o?"":e.trim(),i=r.find(e=>e.email===n||e.phone===a);if(!i)return{success:!1,error:"Invalid email/phone or password"};if(!i.passwordHash||""===i.passwordHash)return{success:!1,error:"این حساب کاربری نیاز به تنظیم مجدد رمز عبور دارد. لطفاً دوباره ثبت نام کنید."};let l=await s(t);if(i.passwordHash!==l)return{success:!1,error:"Invalid email/phone or password"};return localStorage.setItem("session_user_id",i.id.toString()),localStorage.setItem("user_email",i.email),localStorage.setItem("user_phone",i.phone),localStorage.setItem("user_name",i.name),{success:!0,user:i}}catch(e){return console.error("Login error:",e),{success:!1,error:"خطا در ورود"}}}function p(){localStorage.removeItem("session_user_id"),localStorage.removeItem("user_email"),localStorage.removeItem("user_phone"),localStorage.removeItem("user_name")}function f(){try{let e=localStorage.getItem("session_user_id");if(!e)return null;return c().find(t=>t.id.toString()===e)||null}catch(e){return console.error("Error getting session user:",e),null}}function S(){return null!==f()}function y(){p()}}},e=>{var t=t=>e(e.s=t);e.O(0,[8441,1684,7358],()=>t(6161)),_N_E=e.O()}]);