(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8733],{405:(e,t,s)=>{Promise.resolve().then(s.bind(s,3910))},3910:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>n});var r=s(5155),l=s(2115),a=s(9323);function n(){let[e,t]=(0,l.useState)(""),[n,o]=(0,l.useState)("all"),[i,d]=(0,l.useState)([]),[c,m]=(0,l.useState)([]),[u,h]=(0,l.useState)(!1),[x,p]=(0,l.useState)(null),[g,f]=(0,l.useState)([]),[v,b]=(0,l.useState)(!0),[y,j]=(0,l.useState)(""),N=()=>{try{b(!0);let e=(0,a.lo)(),t=(Array.isArray(e)?e:[]).map(e=>{var t,s,r,l;let a,n="number"==typeof e.id||"string"==typeof e.id?e.id:String(null!==(t=e.id)&&void 0!==t?t:"");return null!=e.visibleGiftCards&&(Array.isArray(e.visibleGiftCards)?a=e.visibleGiftCards:"string"==typeof e.visibleGiftCards&&(a=e.visibleGiftCards)),{id:n,name:null!==(s=e.name)&&void 0!==s?s:"کاربر بدون نام",email:null!==(r=e.email)&&void 0!==r?r:null,phone:null!==(l=e.phone)&&void 0!==l?l:null,role:e.role||"user",status:e.status||"active",createdAt:e.createdAt||new Date().toISOString(),orders:"number"==typeof e.orders?e.orders:0,totalSpent:"string"==typeof e.totalSpent?e.totalSpent:"0",visibleGiftCards:a}});d(t),j(""),console.log("✅ Users loaded from localStorage:",t.length,"users")}catch(e){console.error("❌ خطا در بارگذاری کاربران:",e),j("خطا در بارگذاری کاربران"),d([])}finally{b(!1)}},w=()=>{let e=localStorage.getItem("admin_gift_cards");if(e)try{let t=JSON.parse(e);Array.isArray(t)&&t.length>0?(m(t),console.log("✅ Gift cards loaded:",t.length,"cards")):console.warn("⚠️ Gift cards array is empty or invalid")}catch(e){console.error("❌ خطا در بارگذاری گیفت کارت‌ها:",e)}else console.warn("⚠️ No gift cards found in localStorage")};(0,l.useEffect)(()=>{N(),w();let e=setInterval(w,2e3),t=setInterval(N,2e3),s=()=>{console.log("\uD83D\uDCE2 usersUpdated event (AdminUsers) - reloading users"),N()};return window.addEventListener("usersUpdated",s),()=>{clearInterval(e),clearInterval(t),window.removeEventListener("usersUpdated",s)}},[]),(0,l.useEffect)(()=>{u&&(console.log("\uD83D\uDD04 Modal opened, reloading gift cards..."),w())},[u]);let S=e=>{console.log("\uD83C\uDF81 Opening gift cards modal for user:",{userId:e.id,userName:e.name,rawVisibleGiftCards:e.visibleGiftCards,giftCardsAvailable:c.length});let t=[],s=e.visibleGiftCards;if("string"==typeof s&&""!==s.trim())try{let e=JSON.parse(s);t=(Array.isArray(e)?e:[]).map(e=>"string"==typeof e?parseInt(e,10):Number(e))}catch(e){t=[]}else Array.isArray(s)&&(t=s.map(e=>"string"==typeof e?parseInt(e,10):Number(e)));0===t.length&&c.length>0&&console.log("\uD83D\uDCCB Using default cards:",t=c.filter(e=>!0===e.showByDefault&&"flow-money"!==e.brandKey).map(e=>e.id)),console.log("✅ Setting selectedGiftCardIds:",t),p(e),f(t),h(!0)},C=async()=>{if(!x){console.error("❌ No user selected");return}console.log("\uD83D\uDCBE Saving gift cards for user:",{userId:x.id,userName:x.name,selectedCards:g,selectedCardsType:typeof g,selectedCardsLength:g.length});try{let e=(0,a.lo)();console.log("\uD83D\uDCCB All users before update:",e.length);let t=e.findIndex(e=>e.id.toString()===x.id);if(-1===t){console.error("❌ User not found. User ID:",x.id),console.error("\uD83D\uDCCB Available user IDs:",e.map(e=>e.id));return}console.log("✅ User found at index:",t),console.log("\uD83D\uDCCB User before update:",{id:e[t].id,name:e[t].name,currentVisibleGiftCards:e[t].visibleGiftCards});let r=Array.isArray(g)?g.map(e=>"string"==typeof e?parseInt(e,10):e):[];e[t].visibleGiftCards=r,console.log("\uD83D\uDCCB User after update:",{id:e[t].id,name:e[t].name,newVisibleGiftCards:e[t].visibleGiftCards});let{saveUsers:l}=await Promise.resolve().then(s.bind(s,9323));l(e),console.log("✅ Gift cards saved to localStorage via saveUsers"),N(),h(!1),p(null),f([]),alert("گیفت کارت‌های ".concat(x.name," با موفقیت ذخیره شد"))}catch(e){console.error("❌ Error saving gift cards:",e),alert("خطا در ذخیره‌سازی گیفت کارت‌ها. لطفاً دوباره تلاش کنید.")}},I=i.filter(t=>{let s="all"===n||t.status===n,r=t.name.toLowerCase().includes(e.toLowerCase())||t.email&&t.email.toLowerCase().includes(e.toLowerCase())||t.phone&&t.phone.includes(e);return s&&r}),k=e=>{try{if(!e)return"نامشخص";let t=new Date(e);if(isNaN(t.getTime()))return"نامشخص";return t.toLocaleDateString("fa-IR")}catch(e){return"نامشخص"}};return v&&0===i.length?(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsx)("div",{className:"text-slate-300",children:"در حال بارگذاری..."})}):(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-slate-100",children:"مدیریت کاربران"}),(0,r.jsx)("p",{className:"text-sm text-slate-400 mt-1",children:"مشاهده و مدیریت کاربران سیستم"})]}),(0,r.jsx)("div",{className:"flex gap-3",children:(0,r.jsx)("button",{onClick:N,className:"px-4 py-2.5 bg-white/5 text-slate-200 font-medium rounded-xl hover:bg-white/10 transition-all border border-white/10",children:"\uD83D\uDD04 به‌روزرسانی"})})]}),y&&(0,r.jsx)("div",{className:"glass-panel rounded-2xl p-4 border border-red-500/30",children:(0,r.jsx)("p",{className:"text-red-300",children:y})}),(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[(0,r.jsx)("div",{className:"glass-panel rounded-2xl p-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-slate-400 mb-1",children:"کل کاربران"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-slate-100",children:i.length})]}),(0,r.jsx)("div",{className:"w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center",children:(0,r.jsx)("svg",{className:"w-6 h-6 text-blue-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"})})})]})}),(0,r.jsx)("div",{className:"glass-panel rounded-2xl p-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-slate-400 mb-1",children:"کاربران فعال"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-slate-100",children:i.filter(e=>"active"===e.status).length})]}),(0,r.jsx)("div",{className:"w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center",children:(0,r.jsx)("svg",{className:"w-6 h-6 text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})})]})}),(0,r.jsx)("div",{className:"glass-panel rounded-2xl p-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-slate-400 mb-1",children:"کاربران مسدود"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-slate-100",children:i.filter(e=>"banned"===e.status).length})]}),(0,r.jsx)("div",{className:"w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center",children:(0,r.jsx)("svg",{className:"w-6 h-6 text-red-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"})})})]})})]}),(0,r.jsx)("div",{className:"glass-panel rounded-2xl p-6",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"جستجو"}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("svg",{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,r.jsx)("input",{type:"text",placeholder:"جستجو بر اساس نام، ایمیل یا شماره تلفن...",value:e,onChange:e=>t(e.target.value),className:"w-full pr-10 pl-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-slate-200 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500/50"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"فیلتر بر اساس وضعیت"}),(0,r.jsxs)("select",{value:n,onChange:e=>o(e.target.value),className:"w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500/50",children:[(0,r.jsx)("option",{value:"all",children:"همه"}),(0,r.jsx)("option",{value:"active",children:"فعال"}),(0,r.jsx)("option",{value:"banned",children:"مسدود"})]})]})]})}),(0,r.jsx)("div",{className:"glass-panel rounded-2xl overflow-hidden",children:(0,r.jsx)("div",{className:"overflow-x-auto",children:0===I.length?(0,r.jsxs)("div",{className:"p-8 text-center text-slate-400",children:[(0,r.jsx)("p",{children:"هیچ کاربری یافت نشد"}),(0,r.jsxs)("p",{className:"text-sm mt-2",children:["تعداد کل کاربران: ",i.length]})]}):(0,r.jsxs)("table",{className:"w-full",children:[(0,r.jsx)("thead",{className:"bg-white/5",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"نام"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"ایمیل"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"شماره تلفن"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"نقش"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"تعداد سفارش"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"کل خرید"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"وضعیت"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"تاریخ عضویت"}),(0,r.jsx)("th",{className:"text-right py-4 px-6 text-sm font-semibold text-slate-400",children:"عملیات"})]})}),(0,r.jsx)("tbody",{children:I.map(e=>(0,r.jsxs)("tr",{className:"border-b border-white/5 hover:bg-white/5 transition-colors",children:[(0,r.jsx)("td",{className:"py-4 px-6",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-r from-cyan-500 to-purple-600 flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-white font-semibold",children:e.name[0]})}),(0,r.jsx)("span",{className:"text-sm text-slate-200 font-medium",children:e.name})]})}),(0,r.jsx)("td",{className:"py-4 px-6 text-sm text-slate-300",children:e.email||"-"}),(0,r.jsx)("td",{className:"py-4 px-6 text-sm text-slate-300",children:e.phone||"-"}),(0,r.jsx)("td",{className:"py-4 px-6",children:(0,r.jsx)("span",{className:"inline-flex px-3 py-1 text-xs font-medium rounded-full border ".concat("admin"===e.role?"bg-purple-500/20 text-purple-400 border-purple-500/30":"bg-blue-500/20 text-blue-400 border-blue-500/30"),children:"admin"===e.role?"مدیر":"کاربر"})}),(0,r.jsx)("td",{className:"py-4 px-6 text-sm text-slate-200",children:e.orders||0}),(0,r.jsxs)("td",{className:"py-4 px-6 text-sm text-slate-200 font-medium",children:[e.totalSpent||"۰"," تومان"]}),(0,r.jsx)("td",{className:"py-4 px-6",children:(0,r.jsx)("span",{className:"inline-flex px-3 py-1 text-xs font-medium rounded-full border ".concat("active"===e.status?"bg-green-500/20 text-green-400 border-green-500/30":"bg-red-500/20 text-red-400 border-red-500/30"),children:"active"===e.status?"فعال":"مسدود"})}),(0,r.jsx)("td",{className:"py-4 px-6 text-sm text-slate-400",children:k(e.createdAt)}),(0,r.jsx)("td",{className:"py-4 px-6",children:(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,r.jsx)("button",{onClick:()=>S(e),className:"text-purple-400 hover:text-purple-300 text-sm font-medium px-2 py-1 rounded hover:bg-purple-500/10 transition-colors",children:"گیفت کارت‌ها"}),(0,r.jsx)("button",{className:"text-cyan-400 hover:text-cyan-300 text-sm font-medium",children:"ویرایش"}),"active"===e.status?(0,r.jsx)("button",{className:"text-red-400 hover:text-red-300 text-sm font-medium",children:"مسدود"}):(0,r.jsx)("button",{className:"text-green-400 hover:text-green-300 text-sm font-medium",children:"فعال"})]})})]},e.id))})]})})}),u&&x&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50",onClick:()=>h(!1)}),(0,r.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4",children:(0,r.jsxs)("div",{className:"glass-panel rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",onClick:e=>e.stopPropagation(),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h2",{className:"text-2xl font-bold text-slate-100",children:["مدیریت گیفت کارت‌های ",x.name]}),(0,r.jsx)("p",{className:"text-sm text-slate-400 mt-1",children:"گیفت کارت‌هایی که برای این کاربر نمایش داده می‌شود را انتخاب کنید"})]}),(0,r.jsx)("button",{onClick:()=>h(!1),className:"p-2 text-slate-400 hover:text-slate-200 hover:bg-white/10 rounded-lg transition-colors",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsx)("div",{className:"space-y-3 mb-6 max-h-[400px] overflow-y-auto",children:0===c.length?(0,r.jsxs)("div",{className:"text-center py-8 text-slate-400",children:[(0,r.jsx)("p",{children:"هیچ گیفت کارتی یافت نشد"}),(0,r.jsx)("p",{className:"text-sm mt-2",children:'لطفاً ابتدا از صفحه "گیفت کارت ها" گیفت کارت اضافه کنید'})]}):c.map(e=>(0,r.jsxs)("label",{className:"flex items-center gap-3 p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-colors cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:g.includes(e.id),onChange:t=>{let s=e.id,r=t.target.checked;if(console.log("\uD83D\uDD18 Checkbox changed: ".concat(e.brand," (ID: ").concat(s,") - ").concat(r?"checked":"unchecked")),console.log("\uD83D\uDCCB Current selectedGiftCardIds before:",g),r){let e=[...g,s];console.log("✅ Adding card ".concat(s,". New array:"),e),f(e)}else{let e=g.filter(e=>e!==s);console.log("❌ Removing card ".concat(s,". New array:"),e),f(e)}},className:"form-checkbox h-5 w-5 text-cyan-500 bg-white/10 border-white/20 rounded focus:ring-cyan-500"}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-slate-200 font-medium",children:e.brand}),(0,r.jsx)("p",{className:"text-xs text-slate-400 mt-1",children:e.brandKey})]})]},e.id))}),(0,r.jsxs)("div",{className:"flex gap-3 pt-6 border-t border-white/10",children:[(0,r.jsx)("button",{onClick:()=>h(!1),className:"flex-1 px-4 py-2.5 bg-white/5 text-slate-200 rounded-lg hover:bg-white/10 transition-colors font-medium",children:"انصراف"}),(0,r.jsx)("button",{onClick:C,className:"flex-1 px-4 py-2.5 bg-gradient-to-r from-cyan-500 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg hover:shadow-cyan-500/25 transition-all",children:"ذخیره"})]})]})})]})]})}},9323:(e,t,s)=>{"use strict";async function r(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}s.d(t,{M3:()=>f,Wy:()=>v,aN:()=>g,iD:()=>x,ku:()=>m,kz:()=>h,lo:()=>d,ri:()=>p,saveUsers:()=>c,u6:()=>u});let l="users",a="users_backup",n=!1,o=!1;function i(e){if(!e)return null;try{let t=JSON.parse(e);return Array.isArray(t)?t:null}catch(e){return console.error("❌ Error parsing users JSON:",e),null}}function d(){let e=i(localStorage.getItem(l));if(e)return e;let t=i(localStorage.getItem(a));return t?(console.warn("⚠️ Using users_backup because users JSON is invalid"),t):(console.log("\uD83D\uDCCB No valid users found in localStorage"),[])}function c(e){try{if(!Array.isArray(e)){console.error("❌ Cannot save users: not an array",e);return}let t=localStorage.getItem(l);t&&localStorage.setItem(a,t),localStorage.setItem(l,JSON.stringify(e)),localStorage.setItem("users_last_updated",Date.now().toString()),console.log("✅ Saved users to localStorage:",e.length,"users"),"undefined"!=typeof fetch&&Promise.all([fetch("http://localhost:3000/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null),fetch("http://localhost:3001/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null)]).then(()=>{console.log("\uD83D\uDCE1 Synced users to both ports via API")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)}),window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event from saveUsers")}catch(e){console.error("❌ Error saving users:",e)}}function m(){if(n)return;n=!0;try{if("1"===window.sessionStorage.getItem("admin_users_migrated_once"))return}catch(e){}let e=localStorage.getItem(l),t=localStorage.getItem("admin_users"),s=i(e)||[];if(t)try{let e=i(t)||[];if(Array.isArray(e)&&e.length>0){let t=e.map(e=>{let t=new Date().toISOString();if(e.joinDate)try{let s=new Date(e.joinDate);isNaN(s.getTime())||(t=s.toISOString())}catch(e){t=new Date().toISOString()}return{id:e.id||Date.now()+Math.random(),name:e.name||"",email:e.email||"",phone:e.phone||"",role:"admin"===e.role?"admin":"user",passwordHash:e.passwordHash||"",createdAt:t,orders:e.orders||0,totalSpent:e.totalSpent||"۰",status:e.status||"active",joinDate:e.joinDate,visibleGiftCards:e.visibleGiftCards||[]}}),r=new Map,l=e=>{let t=e.email&&e.email.trim().toLowerCase()||e.phone&&e.phone.trim()||e.id.toString();r.has(t)||r.set(t,e)};s.forEach(l),t.forEach(l);let a=Array.from(r.values());a.length!==s.length&&(console.log("✅ Migrated and merged users from admin_users into users:","before:",s.length,"after:",a.length),c(a)),localStorage.removeItem("admin_users"),localStorage.setItem("admin_users_migrated","true");try{window.sessionStorage.setItem("admin_users_migrated_once","1")}catch(e){}}}catch(e){console.error("❌ Error migrating users:",e)}}async function u(){if(!o){o=!0;try{if("1"===window.sessionStorage.getItem("admin_seeded_once"))return}catch(e){}try{let e=d();if(0===e.length)console.log("ℹ️ No users found, seeding default admin user");else if(e.some(e=>"admin"===e.role||"admin@example.com"===e.email))return;let t=await r("Admin@12345"),s={id:Date.now(),name:"مدیر سیستم",email:"admin@example.com",phone:"",role:"admin",passwordHash:t,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};e.push(s),c(e),console.log("✅ Seeded default admin user:",s.email);try{window.sessionStorage.setItem("admin_seeded_once","1")}catch(e){}}catch(e){console.error("❌ Error seeding admin user:",e)}}}async function h(e,t,s,l){try{let a=d(),n=t.trim(),o=s.trim();console.log("\uD83D\uDD0D Registering user:",{name:e,email:n,phone:o,totalUsers:a.length});let i=a.find(e=>n&&e.email&&e.email===n?(console.log("❌ Found existing user with email:",e.email),!0):!!o&&!!e.phone&&e.phone===o&&(console.log("❌ Found existing user with phone:",e.phone),!0));if(i)return console.log("❌ User already exists:",i),{success:!1,error:"این ایمیل یا شماره تلفن قبلاً ثبت شده است"};console.log("✅ No duplicate found, creating new user...");let m=await r(l),u={id:Date.now(),name:e.trim(),email:n,phone:o,role:"user",passwordHash:m,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};a.push(u),c(a),console.log("✅ New user registered and saved:",{id:u.id,name:u.name,email:u.email,phone:u.phone,totalUsers:a.length});try{fetch("/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:a})}).then(()=>{console.log("\uD83D\uDCE1 Synced users to API endpoint")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)})}catch(e){}return window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event"),{success:!0,user:u}}catch(e){return console.error("Registration error:",e),{success:!1,error:"خطا در ثبت نام"}}}async function x(e,t){try{let s=d(),l=e.includes("@"),a=l?e.trim():"",n=l?"":e.trim(),o=s.find(e=>e.email===a||e.phone===n);if(!o)return{success:!1,error:"Invalid email/phone or password"};if(!o.passwordHash||""===o.passwordHash)return{success:!1,error:"این حساب کاربری نیاز به تنظیم مجدد رمز عبور دارد. لطفاً دوباره ثبت نام کنید."};let i=await r(t);if(o.passwordHash!==i)return{success:!1,error:"Invalid email/phone or password"};return localStorage.setItem("session_user_id",o.id.toString()),localStorage.setItem("user_email",o.email),localStorage.setItem("user_phone",o.phone),localStorage.setItem("user_name",o.name),{success:!0,user:o}}catch(e){return console.error("Login error:",e),{success:!1,error:"خطا در ورود"}}}function p(){localStorage.removeItem("session_user_id"),localStorage.removeItem("user_email"),localStorage.removeItem("user_phone"),localStorage.removeItem("user_name")}function g(){try{let e=localStorage.getItem("session_user_id");if(!e)return null;return d().find(t=>t.id.toString()===e)||null}catch(e){return console.error("Error getting session user:",e),null}}function f(){return null!==g()}function v(){p()}}},e=>{var t=t=>e(e.s=t);e.O(0,[8441,1684,7358],()=>t(405)),_N_E=e.O()}]);