"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8406],{8406:(e,t,r)=>{r.d(t,{AuthProvider:()=>i,A:()=>d});var o=r(5155),s=r(2115),n=r(9323);function l(e){let{isOpen:t,onClose:r,initialTab:l="login"}=e,{closeAuthModal:a}=d(),[i,c]=(0,s.useState)(l),[u,m]=(0,s.useState)(!1),[h,g]=(0,s.useState)("");if((0,s.useEffect)(()=>{t&&c(l)},[t,l]),(0,s.useEffect)(()=>{let e=e=>{"Escape"===e.key&&t&&r()},o=e=>{e.target.closest(".overflow-y-auto")||e.preventDefault()};if(t){document.addEventListener("keydown",e),document.addEventListener("touchmove",o,{passive:!1});let t=window.scrollY,r=document.body.style.overflow,s=document.body.style.position,n=document.body.style.width,l=document.body.style.top,a=document.body.style.overscrollBehavior;return document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%",document.body.style.top="-".concat(t,"px"),document.body.style.overscrollBehavior="none",()=>{document.removeEventListener("keydown",e),document.removeEventListener("touchmove",o),document.body.style.overflow=r,document.body.style.position=s,document.body.style.width=n,document.body.style.top=l,document.body.style.overscrollBehavior=a,window.scrollTo(0,t)}}return()=>{document.removeEventListener("keydown",e),document.removeEventListener("touchmove",o)}},[t,r]),!t)return null;let p=async e=>{e.preventDefault(),m(!0),g("");let t=new FormData(e.currentTarget),r=t.get("identifier"),o=t.get("password");if(!r||!o){g("لطفاً تمام فیلدها را پر کنید"),m(!1);return}try{var s;let e=await (0,n.iD)(r.trim(),o);if(!e.success){g(e.error||"ایمیل/شماره تلفن یا رمز عبور اشتباه است"),m(!1);return}a(),(null===(s=e.user)||void 0===s?void 0:s.role)==="admin"&&alert("برای دسترسی به پنل ادمین، لطفاً از آدرس /admin/login وارد شوید"),window.location.href="/dashboard"}catch(e){console.error("Login error:",e),g("خطا در ورود. لطفاً دوباره تلاش کنید."),m(!1)}},f=async e=>{e.preventDefault(),m(!0),g("");let t=new FormData(e.currentTarget),r=t.get("firstName"),o=t.get("lastName"),s=t.get("email"),l=t.get("phone"),i=t.get("password"),d=t.get("confirmPassword");if(!r||!o||!s||!l||!i||!d){g("لطفاً تمام فیلدها را پر کنید"),m(!1);return}let c="".concat(r," ").concat(o).trim();if(c.length<2){g("نام باید حداقل ۲ کاراکتر باشد"),m(!1);return}if(i.length<6){g("رمز عبور باید حداقل ۶ کاراکتر باشد"),m(!1);return}if(i!==d){g("رمز عبور و تکرار آن مطابقت ندارند"),m(!1);return}try{let e=await (0,n.kz)(c,s.trim(),l.trim(),i);if(!e.success){g(e.error||"خطا در ثبت نام"),m(!1);return}e.user&&(localStorage.setItem("session_user_id",e.user.id.toString()),localStorage.setItem("user_email",e.user.email),localStorage.setItem("user_phone",e.user.phone),localStorage.setItem("user_name",e.user.name),window.dispatchEvent(new CustomEvent("usersUpdated")),a(),"admin"===e.user.role?window.location.href="/admin":window.location.href="/dashboard")}catch(e){console.error("Registration error:",e),g("خطا در ثبت نام. لطفاً دوباره تلاش کنید."),m(!1)}};return(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200",style:{overscrollBehavior:"none"},children:[(0,o.jsx)("div",{className:"absolute inset-0 bg-black/80 backdrop-blur-sm",onClick:r}),(0,o.jsxs)("div",{className:"relative z-10 w-full max-w-md max-h-[90vh] glass-card rounded-2xl shadow-2xl animate-in zoom-in duration-200 flex flex-col overflow-hidden",onClick:e=>e.stopPropagation(),children:[(0,o.jsx)("button",{onClick:r,className:"absolute left-4 top-4 z-20 w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-colors","aria-label":"بستن",children:(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,o.jsxs)("div",{className:"overflow-y-auto overscroll-contain flex-1 px-8 pt-12 pb-8",children:[(0,o.jsxs)("div",{className:"flex gap-2 mb-6 bg-white/5 p-1 rounded-lg",children:[(0,o.jsx)("button",{type:"button",onClick:()=>{c("login"),g("")},className:"flex-1 px-4 py-2 rounded-md text-sm font-medium transition-all ".concat("login"===i?"bg-gradient-to-r from-blue-500 to-purple-600 text-white":"text-gray-400 hover:text-white"),children:"ورود"}),(0,o.jsx)("button",{type:"button",onClick:()=>{c("register"),g("")},className:"flex-1 px-4 py-2 rounded-md text-sm font-medium transition-all ".concat("register"===i?"bg-gradient-to-r from-blue-500 to-purple-600 text-white":"text-gray-400 hover:text-white"),children:"ثبت نام"})]}),"login"===i&&(0,o.jsxs)("form",{onSubmit:p,className:"space-y-5",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:"ورود"}),(0,o.jsx)("p",{className:"text-sm text-gray-400",children:"به حساب کاربری خود وارد شوید"})]}),h&&(0,o.jsx)("div",{className:"p-3 bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-300",children:h}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"login-email",className:"block text-sm font-medium text-gray-300 mb-2",children:"شماره موبایل یا ایمیل"}),(0,o.jsx)("input",{id:"login-email",name:"identifier",type:"text",required:!0,autoComplete:"username",className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"09123456789 یا example@email.com"})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"login-password",className:"block text-sm font-medium text-gray-300 mb-2",children:"رمز عبور"}),(0,o.jsx)("input",{id:"login-password",name:"password",type:"password",required:!0,autoComplete:"current-password",className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"••••••••"})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)("input",{type:"checkbox",id:"remember",className:"w-4 h-4 rounded bg-white/5 border-white/10 text-blue-500 focus:ring-blue-500/50"}),(0,o.jsx)("label",{htmlFor:"remember",className:"text-sm text-gray-400",children:"مرا به خاطر بسپار"})]}),(0,o.jsx)("button",{type:"submit",disabled:u,className:"w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all shadow-lg shadow-blue-500/25 disabled:opacity-50 disabled:cursor-not-allowed",children:u?"در حال ورود...":"ورود"})]}),"register"===i&&(0,o.jsxs)("form",{onSubmit:f,className:"space-y-5",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:"ثبت نام"}),(0,o.jsx)("p",{className:"text-sm text-gray-400",children:"حساب کاربری جدید ایجاد کنید"})]}),h&&(0,o.jsx)("div",{className:"p-3 bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-300",children:h}),(0,o.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"register-first-name",className:"block text-sm font-medium text-gray-300 mb-2",children:"نام"}),(0,o.jsx)("input",{id:"register-first-name",name:"firstName",type:"text",required:!0,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"نام"})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"register-last-name",className:"block text-sm font-medium text-gray-300 mb-2",children:"نام خانوادگی"}),(0,o.jsx)("input",{id:"register-last-name",name:"lastName",type:"text",required:!0,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"نام خانوادگی"})]})]}),(0,o.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,o.jsxs)("div",{className:"md:order-1",children:[(0,o.jsx)("label",{htmlFor:"register-phone",className:"block text-sm font-medium text-gray-300 mb-2",children:"شماره موبایل"}),(0,o.jsx)("input",{id:"register-phone",name:"phone",type:"tel",required:!0,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"09123456789"})]}),(0,o.jsxs)("div",{className:"md:order-2",children:[(0,o.jsx)("label",{htmlFor:"register-email",className:"block text-sm font-medium text-gray-300 mb-2",children:"ایمیل"}),(0,o.jsx)("input",{id:"register-email",name:"email",type:"email",required:!0,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"example@email.com"})]})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"register-password",className:"block text-sm font-medium text-gray-300 mb-2",children:"رمز عبور"}),(0,o.jsx)("input",{id:"register-password",name:"password",type:"password",required:!0,minLength:6,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"حداقل ۶ کاراکتر"})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{htmlFor:"register-confirm-password",className:"block text-sm font-medium text-gray-300 mb-2",children:"تکرار رمز عبور"}),(0,o.jsx)("input",{id:"register-confirm-password",name:"confirmPassword",type:"password",required:!0,minLength:6,className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all",placeholder:"رمز عبور را تکرار کنید"})]}),(0,o.jsx)("button",{type:"submit",disabled:u,className:"w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all shadow-lg shadow-blue-500/25 disabled:opacity-50 disabled:cursor-not-allowed",children:u?"در حال ثبت نام...":"ثبت نام"})]})]})]})]})}let a=(0,s.createContext)(void 0);function i(e){let{children:t}=e,[r,i]=(0,s.useState)(!1),[d,c]=(0,s.useState)(!1),[u,m]=(0,s.useState)("login");(0,s.useEffect)(()=>{(0,n.ku)(),(0,n.u6)().catch(console.error)},[]);let h=(0,s.useCallback)(()=>{c((0,n.M3)())},[]);(0,s.useEffect)(()=>{queueMicrotask(()=>{h()});let e=setInterval(h,500),t=e=>{"session_user_id"===e.key&&(console.log("\uD83D\uDCE2 Storage changed: session_user_id - checking auth..."),queueMicrotask(()=>{h()}))};return window.addEventListener("storage",t),()=>{clearInterval(e),window.removeEventListener("storage",t)}},[h]);let g=(0,s.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"login";m(e),i(!0)},[]),p=(0,s.useCallback)(()=>i(!1),[]),f=(0,s.useCallback)(()=>{i(!1)},[]),b=(0,s.useCallback)(()=>{(0,n.Wy)(),localStorage.removeItem("session_user_id"),localStorage.removeItem("user_email"),localStorage.removeItem("user_phone"),localStorage.removeItem("user_name"),c(!1)},[]);return(0,o.jsxs)(a.Provider,{value:{isModalOpen:r,openAuthModal:g,closeAuthModal:p,isLoggedIn:d,loginDemo:f,logoutDemo:b,authModalTab:u},children:[t,r&&(0,o.jsx)(l,{isOpen:r,onClose:p,initialTab:u})]})}function d(){let e=(0,s.useContext)(a);if(void 0===e)throw Error("useAuth must be used within AuthProvider");return e}},9323:(e,t,r)=>{async function o(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}r.d(t,{M3:()=>b,Wy:()=>w,aN:()=>f,iD:()=>g,ku:()=>u,kz:()=>h,lo:()=>d,ri:()=>p,saveUsers:()=>c,u6:()=>m});let s="users",n="users_backup",l=!1,a=!1;function i(e){if(!e)return null;try{let t=JSON.parse(e);return Array.isArray(t)?t:null}catch(e){return console.error("❌ Error parsing users JSON:",e),null}}function d(){let e=i(localStorage.getItem(s));if(e)return e;let t=i(localStorage.getItem(n));return t?(console.warn("⚠️ Using users_backup because users JSON is invalid"),t):(console.log("\uD83D\uDCCB No valid users found in localStorage"),[])}function c(e){try{if(!Array.isArray(e)){console.error("❌ Cannot save users: not an array",e);return}let t=localStorage.getItem(s);t&&localStorage.setItem(n,t),localStorage.setItem(s,JSON.stringify(e)),localStorage.setItem("users_last_updated",Date.now().toString()),console.log("✅ Saved users to localStorage:",e.length,"users"),"undefined"!=typeof fetch&&Promise.all([fetch("http://localhost:3000/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null),fetch("http://localhost:3001/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).catch(()=>null)]).then(()=>{console.log("\uD83D\uDCE1 Synced users to both ports via API")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)}),window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event from saveUsers")}catch(e){console.error("❌ Error saving users:",e)}}function u(){if(l)return;l=!0;try{if("1"===window.sessionStorage.getItem("admin_users_migrated_once"))return}catch(e){}let e=localStorage.getItem(s),t=localStorage.getItem("admin_users"),r=i(e)||[];if(t)try{let e=i(t)||[];if(Array.isArray(e)&&e.length>0){let t=e.map(e=>{let t=new Date().toISOString();if(e.joinDate)try{let r=new Date(e.joinDate);isNaN(r.getTime())||(t=r.toISOString())}catch(e){t=new Date().toISOString()}return{id:e.id||Date.now()+Math.random(),name:e.name||"",email:e.email||"",phone:e.phone||"",role:"admin"===e.role?"admin":"user",passwordHash:e.passwordHash||"",createdAt:t,orders:e.orders||0,totalSpent:e.totalSpent||"۰",status:e.status||"active",joinDate:e.joinDate,visibleGiftCards:e.visibleGiftCards||[]}}),o=new Map,s=e=>{let t=e.email&&e.email.trim().toLowerCase()||e.phone&&e.phone.trim()||e.id.toString();o.has(t)||o.set(t,e)};r.forEach(s),t.forEach(s);let n=Array.from(o.values());n.length!==r.length&&(console.log("✅ Migrated and merged users from admin_users into users:","before:",r.length,"after:",n.length),c(n)),localStorage.removeItem("admin_users"),localStorage.setItem("admin_users_migrated","true");try{window.sessionStorage.setItem("admin_users_migrated_once","1")}catch(e){}}}catch(e){console.error("❌ Error migrating users:",e)}}async function m(){if(!a){a=!0;try{if("1"===window.sessionStorage.getItem("admin_seeded_once"))return}catch(e){}try{let e=d();if(0===e.length)console.log("ℹ️ No users found, seeding default admin user");else if(e.some(e=>"admin"===e.role||"admin@example.com"===e.email))return;let t=await o("Admin@12345"),r={id:Date.now(),name:"مدیر سیستم",email:"admin@example.com",phone:"",role:"admin",passwordHash:t,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};e.push(r),c(e),console.log("✅ Seeded default admin user:",r.email);try{window.sessionStorage.setItem("admin_seeded_once","1")}catch(e){}}catch(e){console.error("❌ Error seeding admin user:",e)}}}async function h(e,t,r,s){try{let n=d(),l=t.trim(),a=r.trim();console.log("\uD83D\uDD0D Registering user:",{name:e,email:l,phone:a,totalUsers:n.length});let i=n.find(e=>l&&e.email&&e.email===l?(console.log("❌ Found existing user with email:",e.email),!0):!!a&&!!e.phone&&e.phone===a&&(console.log("❌ Found existing user with phone:",e.phone),!0));if(i)return console.log("❌ User already exists:",i),{success:!1,error:"این ایمیل یا شماره تلفن قبلاً ثبت شده است"};console.log("✅ No duplicate found, creating new user...");let u=await o(s),m={id:Date.now(),name:e.trim(),email:l,phone:a,role:"user",passwordHash:u,createdAt:new Date().toISOString(),orders:0,totalSpent:"۰",status:"active",visibleGiftCards:[]};n.push(m),c(n),console.log("✅ New user registered and saved:",{id:m.id,name:m.name,email:m.email,phone:m.phone,totalUsers:n.length});try{fetch("/api/users/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:n})}).then(()=>{console.log("\uD83D\uDCE1 Synced users to API endpoint")}).catch(e=>{console.warn("⚠️ Failed to sync to API:",e)})}catch(e){}return window.dispatchEvent(new CustomEvent("usersUpdated")),console.log("\uD83D\uDCE2 Dispatched usersUpdated event"),{success:!0,user:m}}catch(e){return console.error("Registration error:",e),{success:!1,error:"خطا در ثبت نام"}}}async function g(e,t){try{let r=d(),s=e.includes("@"),n=s?e.trim():"",l=s?"":e.trim(),a=r.find(e=>e.email===n||e.phone===l);if(!a)return{success:!1,error:"Invalid email/phone or password"};if(!a.passwordHash||""===a.passwordHash)return{success:!1,error:"این حساب کاربری نیاز به تنظیم مجدد رمز عبور دارد. لطفاً دوباره ثبت نام کنید."};let i=await o(t);if(a.passwordHash!==i)return{success:!1,error:"Invalid email/phone or password"};return localStorage.setItem("session_user_id",a.id.toString()),localStorage.setItem("user_email",a.email),localStorage.setItem("user_phone",a.phone),localStorage.setItem("user_name",a.name),{success:!0,user:a}}catch(e){return console.error("Login error:",e),{success:!1,error:"خطا در ورود"}}}function p(){localStorage.removeItem("session_user_id"),localStorage.removeItem("user_email"),localStorage.removeItem("user_phone"),localStorage.removeItem("user_name")}function f(){try{let e=localStorage.getItem("session_user_id");if(!e)return null;return d().find(t=>t.id.toString()===e)||null}catch(e){return console.error("Error getting session user:",e),null}}function b(){return null!==f()}function w(){p()}}}]);